# Hard Constraints — saas-django

# NON-NEGOTIABLE. Apply every rule to every response without exception.

---

## 1. Package & Environment

- ALWAYS `uv add <pkg>` — NEVER `pip install`
- ALWAYS `uv run <cmd>` — NEVER bare `python manage.py ...`
- `uv.lock` is the single source of truth — run `uv sync` after dependency changes
- Python target: 3.14 | Django target: >=6.0,<6.1

---

## 2. Project Layout

- Settings: `config/settings/base.py` + `dev.py` + `prod.py`
- All Django apps: `apps/<app_name>/`
- New features → new app inside `apps/` if it represents a clear domain boundary
- `manage.py` → `DJANGO_SETTINGS_MODULE=config.settings.dev`
- `wsgi.py` / `asgi.py` → `config.settings.prod`

---

## 3. Database

- PostgreSQL only — NEVER SQLite for any new work
- All PKs: `UUIDField(primary_key=True, default=uuid.uuid4, editable=False)`
- Every tenant-scoped model: `tenant_id = models.UUIDField(db_index=True)`
- Always index `tenant_id` and any frequently filtered field
- Migrations: small and incremental — no large data migrations without rollback plan

---

## 4. Models — Universal Field Rules

Apply to every major data model (not lookup/config tables):

- **UUID PK** (see §3)
- **tenant_id** on all tenant-scoped models (see §3)
- **Soft delete triad:**
  ```python
  is_active   = models.BooleanField(default=True, db_index=True)
  deleted_at  = models.DateTimeField(null=True, blank=True)
  deleted_by  = models.ForeignKey(
      settings.AUTH_USER_MODEL, null=True, blank=True,
      on_delete=models.SET_NULL, related_name="+"
  )
  ```
  > `is_active` is the field all live queries filter on — it gets the index.
  > `deleted_at` and `deleted_by` are audit fields only; querying them is rare and
  > full-scan-acceptable. Django adds an implicit index to the `deleted_by` FK anyway.
- **Timestamps:** `created_at` / `updated_at` via `auto_now_add` / `auto_now`
- **`created_by` / `updated_by`:** Do NOT add these to the abstract base model.
  They cause circular dependency risks (especially on `User` itself) and migration
  complexity. Add them **opt-in**, only on models where attribution genuinely matters
  (e.g. a `Document` or `Invoice`). Document the decision per model in a comment.
- NEVER raw SQL — always use the Django ORM
- Keep `models.py` thin — no business logic

---

## 5. User Model

- ALWAYS subclass `AbstractUser` in `apps/users/`
- Set `USERNAME_FIELD = "email"` and `REQUIRED_FIELDS = []`
- Provide a custom `UserManager` with `create_user(email, password, ...)` and `create_superuser(email, password, ...)`
- Set `AUTH_USER_MODEL = "users.User"` in `config/settings/base.py` before the first migration
- After creating the User model for the first time, run:
  ```
  uv run python manage.py makemigrations
  uv run python manage.py migrate
  uv run python manage.py createsuperuser
  ```
- Login/logout always uses **email + password**, never username
- The `User` model itself stays minimal — all optional profile data lives in `UserProfile`
- **NEVER hard-delete a `User` record.** Set `is_active = False` instead.
  Hard deletion cascades silently and breaks foreign keys across the system.

---

## 5a. UserProfile Model

`UserProfile` is a separate model in `apps/users/` with a `OneToOneField` to `User`.
It holds all optional, editable, user-visible preferences. It is **never** part of
the registration form — it is created automatically after registration via a signal.

**NEVER hard-delete a `UserProfile` record.** Set `is_active = False` instead.

Fields:

```python
class UserProfile(TimeStampedSoftDeleteModel):
    user         = models.OneToOneField(settings.AUTH_USER_MODEL,
                       on_delete=models.CASCADE, related_name="profile")
    # Display
    display_name = models.CharField(max_length=100, blank=True, null=True)
                   # nullable; auto-populated from email on creation (see below)

    # Localisation — FK to ISO reference tables (see §5b)
    language     = models.ForeignKey(
                       "core.Language", null=True, blank=True,
                       on_delete=models.SET_NULL, related_name="+"
                   )
    timezone     = models.ForeignKey(
                       "core.Timezone", null=True, blank=True,
                       on_delete=models.SET_NULL, related_name="+"
                   )
    country      = models.ForeignKey(
                       "core.Country", null=True, blank=True,
                       on_delete=models.SET_NULL, related_name="+"
                   )
    currency     = models.ForeignKey(
                       "core.Currency", null=True, blank=True,
                       on_delete=models.SET_NULL, related_name="+"
                   )

    # UI preferences
    theme        = models.CharField(
                       max_length=20,
                       choices=[("corporate","Light"),("night","Dark"),("system","System")],
                       default="system"
                   )

    # Marketing
    marketing_emails = models.BooleanField(default=False)
                       # newsletters opt-in only — no product_updates field

    # Onboarding gate
    profile_completed_at = models.DateTimeField(null=True, blank=True)
                           # None until the user saves the profile form for the
                           # first time; drives the ProfileCompleteMiddleware gate
```

**Auto-population on registration (signal):**

- `display_name`: take the string left of `@` in the email; if it contains `.`, take
  the string left of the first `.` (e.g. `peter.janssens@...` → `peter`)
- `language` / `timezone` / `country`: attempt to detect from the browser's
  `Accept-Language` header and `Intl.DateTimeFormat().resolvedOptions().timeZone`
  (passed as a hidden field on the registration form)
- All detected values are suggestions — the user can edit them at any time in `/profile/`

**Profile form (`/profile/`):**

- Editable fields: `display_name`, `language`, `timezone`, `country`, `currency`,
  `theme`, `marketing_emails`
- Login required
- Does NOT include email or password (those are in a separate settings section)
- Theme preference in the profile form **also** updates `localStorage` key `theme`
- Language preference in the profile form **also** triggers a locale switch

**Navbar:** see §11 for the full navigation layout spec, including the authenticated
`display_name` dropdown, mobile bottom nav, and aria requirements.

---

## 5b. Reference Data — Countries, Languages, Timezones, Currencies

All ISO reference tables live in `apps/core/` and are loaded once via a management
command (`uv run python manage.py load_reference_data`). They are **not** editable
by end-users and have no soft-delete — they are controlled vocabulary.

### Country (`core.Country`)

```python
class Country(models.Model):
    code        = models.CharField(max_length=2, primary_key=True)   # ISO 3166-1 alpha-2
    code_3      = models.CharField(max_length=3, unique=True)        # ISO 3166-1 alpha-3
    numeric     = models.CharField(max_length=3, unique=True)        # ISO 3166-1 numeric
    name        = models.CharField(max_length=100)
    flag_emoji  = models.CharField(max_length=10, blank=True)

    class Meta:
        ordering = ["name"]
        verbose_name_plural = "countries"
```

### Language (`core.Language`)

```python
class Language(models.Model):
    code        = models.CharField(max_length=10, primary_key=True)  # BCP 47 / IANA tag (e.g. "en-US", "nl-BE", "fr-BE")
    name        = models.CharField(max_length=100)                   # native name
    name_en     = models.CharField(max_length=100)                   # English name
    countries   = models.ManyToManyField("core.Country", blank=True,
                      related_name="languages")
                  # e.g. "nl-BE" links to Belgium; allows filtering:
                  #   Language.objects.filter(countries__code="BE")

    class Meta:
        ordering = ["name_en"]
```

### Timezone (`core.Timezone`)

```python
class Timezone(models.Model):
    name        = models.CharField(max_length=100, primary_key=True) # IANA tz (e.g. "Europe/Brussels")
    offset_std  = models.SmallIntegerField()                         # UTC offset in minutes (standard time)
    offset_dst  = models.SmallIntegerField(null=True, blank=True)    # UTC offset in minutes (DST, null if no DST)
    countries   = models.ManyToManyField("core.Country", blank=True,
                      related_name="timezones")
                  # allows filtering: Timezone.objects.filter(countries__code="BE")

    class Meta:
        ordering = ["offset_std", "name"]
```

### Currency (`core.Currency`)

```python
class Currency(models.Model):
    code        = models.CharField(max_length=3, primary_key=True)   # ISO 4217 alphabetic (e.g. "EUR")
    numeric     = models.CharField(max_length=3, unique=True)        # ISO 4217 numeric
    name        = models.CharField(max_length=100)
    symbol      = models.CharField(max_length=10, blank=True)        # "€", "$", "£"
    decimals    = models.SmallIntegerField(default=2)                # minor units
    countries   = models.ManyToManyField("core.Country", blank=True,
                      related_name="currencies")
                  # allows filtering: Currency.objects.filter(countries__code="BE")

    class Meta:
        ordering = ["code"]
        verbose_name_plural = "currencies"
```

### Filtering patterns

```python
# Languages available for a country
Language.objects.filter(countries__code="BE")

# Timezones for a country
Timezone.objects.filter(countries__code="BE")

# Currencies for a country
Currency.objects.filter(countries__code="BE")
```

### Data source

Populate from `pycountry` (PyPI) in the `load_reference_data` management command:

- `uv add pycountry`
- Countries, languages, currencies: `pycountry.countries`, `pycountry.languages`, `pycountry.currencies`
- Timezones: `zoneinfo.available_timezones()` + `zoneinfo.ZoneInfo` for offset calculation
- Run the command once after initial migrations and in CI seed steps

---

## 5c. Tenants & Membership Models

`Tenant` and `TenantMembership` live in `apps/tenants/`.

### Tenant

```python
class Tenant(TimeStampedSoftDeleteModel):
    id           = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    organization = models.CharField(max_length=200)   # workspace / company name (required)
    # No slug — UUID PK is the identifier; add slug only if tenant-scoped URLs are needed
```

### TenantMembership

```python
class TenantMembership(models.Model):
    id       = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    tenant   = models.ForeignKey(Tenant, on_delete=models.CASCADE, related_name="memberships")
    user     = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE,
                   related_name="memberships")
    role     = models.CharField(max_length=20,
                   choices=[("owner", "Owner"), ("member", "Member")],
                   default="member")
    joined_at = models.DateTimeField(auto_now_add=True)
    is_active = models.BooleanField(default=True)     # False = revoked, not deleted

    class Meta:
        unique_together = [("tenant", "user")]
```

> **No `admin` role** — `owner` is the single privileged role.
> Add granular roles (e.g. `billing`) only when a concrete permission need arises (Phase 5+).

> **No `tenant` FK on `User`** — workspace membership goes through `TenantMembership` only.
> A user may belong to multiple tenants; the FK would lock them to one.

---

## 6. Views & Business Logic

- CBVs (Class-Based Views) for non-trivial logic, FBVs (Function-Based Views) for simple endpoints
- Views must stay thin — delegate to `services.py` / `selectors.py`
- `services.py` — write/mutation logic
- `selectors.py` — read/query logic
- `tasks.py` — async/background work (Celery or Django-Q)

### Login UX

- **Login failure** (wrong credentials): stay on the login form and display an inline
  error message — do **NOT** redirect anywhere. The user must be able to try again immediately.
- **Login cancel** (user actively navigates away, clicks "Back", or hits a "Cancel" link
  on the login page): redirect to **homepage** (`/`).
- After successful login → proceed to `?next` param (or `/dashboard/`).
- Unauthenticated access to protected pages → redirect to **login page** (with `?next`).

### Registration Flow

- After successful registration → skip email confirmation → auto-create `UserProfile`
  via signal → redirect to `/profile/complete/` with page title **"Complete your profile"**.

### Extended Onboarding Flow

New users pass through a two-step onboarding gate after registration:

```
Register → Login → Middleware Check ──→ /profile/complete/   (Step 1: profile incomplete)
                                    ──→ /onboarding/create-tenant/  (Step 2: no tenant)
                                    ──→ Destination            (fully set up)
```

**Step 1 — Profile Completion (`/profile/complete/`):**

- Collect: `display_name`, `timezone`, `avatar` (optional upload)
- Show a DaisyUI **steps** progress indicator: `Profile → Workspace` (step 1 of 2)
- **"Do this later"** button: sets `request.session["skip_profile_gate"] = True`
  so the middleware does not redirect them again during this browser session,
  even if `profile_completed_at` is still `None`
- On form save: set `profile_completed_at = now()` → redirect to Step 2
  (`/onboarding/create-tenant/`)

**Step 2 — Tenant Creation (`/onboarding/create-tenant/`):**

- User creates their first Workspace (Tenant): provide `organization` (workspace name)
- Show the same DaisyUI **steps** progress indicator: `Profile → Workspace` (step 2 of 2)
- On save: create `Tenant`, create `TenantMembership(role="owner", is_active=True)` → redirect to `/dashboard/`
- The creating user is the **owner** of the tenant and can invite/remove members

**Middleware (`ProfileCompleteMiddleware` in `apps/users/middleware.py`):**

Runs on every request **after** `AuthenticationMiddleware`. Only applies to
**authenticated** users. Decision logic:

1. If `profile_completed_at` is `None` AND `request.session.get("skip_profile_gate")` is not `True`:
   → redirect to `/profile/complete/?next=<original_url>`
2. Else if user has no active `TenantMembership`:
   → redirect to `/onboarding/create-tenant/?next=<original_url>`
3. Else: proceed normally.

Exempt from the gate (never redirected, even when checks fail):

- `/profile/complete/`
- `/onboarding/create-tenant/`
- `/logout/`
- `/health/`
- Any URL matching `settings.PROFILE_GATE_EXEMPT_URLS` (a list in `base.py`, default `[]`)

The middleware `TenantMembership` check must query `is_active=True` memberships only —
a revoked member (`is_active=False`) has no active membership and is redirected to
`/onboarding/create-tenant/`.

Public pages (unauthenticated access allowed) are unaffected.

### Tenant Member Management

- `TenantMembership` roles: `owner` and `member` only. No `admin` role until a concrete
  permission need arises.
- `owner` capabilities: invite members by email, revoke access (`is_active=False`),
  re-activate revoked members. An owner **cannot** revoke their own membership.
- `member` capabilities: none — read access to tenant data only.
- Member management UI lives at `/settings/members/` — `owner`-only; non-owners get 403.
- Inviting an email that already has an active membership is a validation error.
- Revoking sets `TenantMembership.is_active = False` (soft-revoke, audit trail preserved).
- Invitation email: send synchronously via Django `send_mail` for now (no Celery yet).

---

## 7. App Structure (per app)

```
apps/<name>/
  models.py
  views.py
  urls.py
  services.py
  selectors.py
  tasks.py        # if async work needed
  admin.py
  apps.py
  migrations/
  tests/
    __init__.py
    test_models.py
    test_views.py
    test_services.py
```

---

## 8. Frontend — Tailwind + DaisyUI

- ALWAYS use **Tailwind CSS** + **DaisyUI** for all templates
- Default DaisyUI theme: **corporate** (light) / **night** (dark)
- Default mode: **follow system** (`prefers-color-scheme`)
- Theme preference stored in `localStorage` key `theme`
- Language preference stored in `localStorage` key `lang`
- Use DaisyUI **skeleton** component during form loads and theme switches to prevent layout shifts
- Use DaisyUI **hero** component for auth pages (split-screen on desktop: inspirational image left, form right)
- Auth forms: centered vertically + horizontally on desktop; `items-start` on mobile so keyboard doesn't overlap fields
- Mobile: **Full-Width Buttons**; use "Top-to-Fill" standard for form fields
- NEVER use a top-right hamburger menu on mobile — use **Bottom Navigation** or **Full-Screen Overlay** instead
- All buttons, inputs, cards, alerts: DaisyUI components first, custom CSS only if DaisyUI has no equivalent

---

## 9. Anti-Flash Script (theme)

Place this script in `<head>` of `base.html` **before any CSS or `<body>` tags**:

```html
<script>
  (function () {
    const stored = localStorage.getItem("theme");
    const prefersDark = window.matchMedia(
      "(prefers-color-scheme: dark)",
    ).matches;
    const theme = stored || (prefersDark ? "night" : "corporate");
    document.documentElement.setAttribute("data-theme", theme);
  })();
</script>
```

---

## 10. Templates & Context Processors

- Create a `context_processors.py` in `config/` (or a shared app) that injects into every template:
  - `SITE_NAME` (from settings)
  - `current_theme` (from request cookie or `localStorage` via initial render)
- Register it in `TEMPLATES → OPTIONS → context_processors` in `base.py`
- This ensures 404, 500, password-reset, and all error pages share the same look

---

## 11. Navigation Layout

### Desktop (≥ lg breakpoint)

- **Top navbar** with:
  - Left: `H` (placeholder for logo) → links to homepage
  - Centre: navigation links (currently: "Home" → homepage)
  - Right: language selector → light/dark/system toggle → auth control
    - **Not authenticated:** "Get started" button → opens login page with link to register
    - **Authenticated:** show `display_name` (fall back to email local-part if null) as a
      DaisyUI **dropdown** button; menu items:
      - "Profile" → `/profile/`
      - "Logout" → `/logout/`
- Use `<nav>` tag — never a generic `<div>` for navigation

### Mobile (< lg breakpoint)

- Bottom Navigation bar or Full-Screen Overlay
- Same options as desktop, mobile-friendly UX
- Authenticated user section in the overlay / bottom sheet:
  - Show `display_name` (or email local-part)
  - "Profile" and "Logout" as list items
- Hamburger icon (if used): must have `aria-label="Toggle menu"`

---

## 12. I18N

- Supported locales: `en-us` (US English), `nl-be` (Belgian Dutch), `fr-be` (Belgian French)
- Use Django's `i18n` framework: `USE_I18N = True`, `LANGUAGE_CODE = "en-us"`
- Wrap all user-facing strings in `{% trans %}` / `_()` from the start
- Language selector in navbar triggers locale switch and stores in `localStorage` key `lang`
- Generate `.po` / `.mo` files with:
  ```
  uv run python manage.py makemessages -l nl_BE
  uv run python manage.py makemessages -l fr_BE
  uv run python manage.py compilemessages
  ```

---

## 13. HTML Forms — General Rules

- Always use the correct HTML input `type`: `type="email"` for emails, `type="password"` for passwords, `type="tel"` for phone numbers, etc.
- Always label every input with `<label for="...">` or `aria-label`
- Use `autocomplete` attributes on all auth fields (`autocomplete="email"`, `autocomplete="current-password"`, etc.)

---

## 14. Accessibility

- Always use semantic HTML: `<nav>`, `<main>`, `<header>`, `<footer>`, `<section>`, `<article>`
- NEVER use a generic `<div>` where a semantic tag exists
- All interactive icons must have `aria-label`
- Hamburger/menu toggle: `aria-label="Toggle menu"`, `aria-expanded` state
- Colour contrast must meet WCAG AA minimum

### 14a. Form Validation & Errors

- A red border alone is **never** sufficient to communicate an error.
- Every input that fails validation **must** receive `aria-invalid="true"`.
- Every error message and hint text **must** be linked to its input via
  `aria-describedby="<error-id>"` — the element with that `id` must contain the
  human-readable error text.
- After a failed form submission the page **must not** simply reload silently.
  Move keyboard focus to either:
  - A **"Summary of Errors"** `<div role="alert">` at the top of the form listing
    all validation failures, **or**
  - The **first invalid input** directly.
- All DaisyUI form components: apply the `.input-error` / `.select-error` modifier
  class alongside `aria-invalid="true"` so the visual and assistive cues are in sync.

### 14b. Keyboard & Focus

- NEVER use `outline: none` without an equally visible custom focus indicator.
  DaisyUI provides default focus rings — keep them and ensure they are not obscured
  by sticky navbars or overlapping elements.
- Every page **must** have a **"Skip to Main Content"** link as the **first
  focusable element** in `<body>`. It must be visually hidden until focused:
  ```html
  <a
    href="#main-content"
    class="sr-only focus:not-sr-only focus:absolute focus:z-50
     focus:px-4 focus:py-2 focus:bg-base-100 focus:text-base-content"
  >
    Skip to main content
  </a>
  ```
  The target `<main id="main-content">` must exist on every page.
- **Focus trapping:** When a modal (`<dialog>`) or a full-screen mobile overlay is
  open, focus **must** be trapped inside it. Tabbing must not reach background content.
  Use a JS focus-trap utility (e.g. `focus-trap` npm package, or a small inline
  implementation). Release the trap when the element closes.
- **Logical tab order:** The DOM order must match the visual reading order
  (top → bottom, left → right). Never use `tabindex` values > 0 to reorder focus.
  Use `tabindex="0"` only to make non-interactive elements focusable when needed.

### 14c. Touch & Gestures (Mobile / Motor)

- **Minimum target size:** All interactive elements (buttons, links, inputs, toggles)
  must be at least **44 × 44 px** (WCAG 2.5.5) — aim for 48 × 48 px for primary actions.
  Apply `min-h-[44px] min-w-[44px]` (Tailwind) where DaisyUI defaults fall short.
- **No dragging-only actions:** Any feature that requires dragging (e.g. a Kanban board,
  a reorderable list, a range slider) **must** provide a button-based alternative
  (e.g. "Move up" / "Move down" arrow buttons, or a numeric input for a slider).
- **Orientation:** Content must work in both portrait and landscape orientations.
  Never lock orientation unless absolutely essential for the feature.

### 14d. Cognitive & Language

- Every page's `<html>` tag **must** carry a valid `lang` attribute matching the
  active Django locale (e.g. `<html lang="en">`, `<html lang="nl">`, `<html lang="fr">`).
  Set this dynamically via a template context variable, not hardcoded.
- **Consistent navigation:** The navbar, sidebar, and footer must appear in the
  same location and the same order across every page. Never reorder navigation items
  per page.
- **Autocomplete on personal data inputs:** Any field that collects information the
  browser can autofill **must** carry the correct `autocomplete` attribute:
  - `autocomplete="name"` / `autocomplete="given-name"`
  - `autocomplete="email"`
  - `autocomplete="current-password"` / `autocomplete="new-password"`
  - `autocomplete="tel"`
  - `autocomplete="country"`, `autocomplete="language"`, etc.
    This is required for WCAG 1.3.5 and helps users with cognitive disabilities.

---

## 15. Health Check

- Expose a `GET /health/` endpoint (FBV, no auth required)
- Returns `{"status": "ok", "db": "ok"}` — checks DB connectivity
- Lives in `apps/core/views.py` or a minimal `apps/health/` app

---

## 16. Security

- NEVER hardcode secrets — always `env("VAR_NAME")`
- NEVER commit `.env` — only `.env.example`
- prod.py must have: `SECURE_SSL_REDIRECT`, `SESSION_COOKIE_SECURE`, `CSRF_COOKIE_SECURE`, HSTS
- Validate and sanitise all user input
- CSRF protection on all state-changing endpoints

---

## 17. Multi-Tenancy

- Tenant isolation via `tenant_id` on every relevant model
- Never write cross-tenant queries unless explicitly instructed
- PostgreSQL Row-Level Security (RLS) is the long-term isolation goal

---

## 18. Date & Time — Store UTC, Display Local

- `USE_TZ = True` in `base.py` (already set by Django default) — NEVER disable
- All `DateTimeField` values are stored in UTC in the database
- All `DateTimeField` on models: never use `auto_now` / `auto_now_add` with naive datetimes
- Display layer: convert UTC → user's local timezone using `UserProfile.timezone`
- Use `zoneinfo` (Python stdlib) for timezone conversion — `import zoneinfo`
- In templates: use a custom template filter or tag `{{ value|localtime:request.user.profile.timezone }}`
- Never display raw UTC to the end user (except in admin or debug views)
- Timezone selection in the profile form uses the IANA timezone database
  (e.g. `Europe/Brussels`, `America/New_York`) — use `zoneinfo.available_timezones()`

---

## 19. Background Tasks (Async)

- Use a task queue (Celery + Redis, or Django-Q) for any async work
- Required for: billing webhooks, long-running jobs, and eventually email sending
- Tasks live in `apps/<name>/tasks.py`
- NEVER block a web request with slow I/O
- **Phase 3 exception:** invitation emails use Django `send_mail` synchronously —
  Celery is deferred to Phase 6. Replace with a task once Celery is installed.

---

## 20. Code Quality

- After ANY new app, model, or file: `uv run ruff check --fix && uv run ruff format`
- Line length: 88 | Quote style: double | Import order: isort via ruff
- First-party modules: `config`, `apps`
- Every new feature MUST include tests under `apps/<name>/tests/`
- Run tests: `uv run python manage.py test`

---

## 21. Git

- Commit messages: imperative mood, concise subject + optional body
- Never commit: `.env`, `db.sqlite3`, `__pycache__`, `.DS_Store`, `staticfiles/`
