# Hard Constraints â€” saas-django

# NON-NEGOTIABLE. Apply every rule to every response without exception.

---

## 1. Package & Environment

- ALWAYS `uv add <pkg>` â€” NEVER `pip install`
- ALWAYS `uv run <cmd>` â€” NEVER bare `python manage.py ...`
- `uv.lock` is the single source of truth â€” run `uv sync` after dependency changes
- Python target: 3.14 | Django target: >=6.0,<6.1

---

## 2. Project Layout

- Settings: `config/settings/base.py` + `dev.py` + `prod.py`
- All Django apps: `apps/<app_name>/`
- New features â†’ new app inside `apps/` if it represents a clear domain boundary
- `manage.py` â†’ `DJANGO_SETTINGS_MODULE=config.settings.dev`
- `wsgi.py` / `asgi.py` â†’ `config.settings.prod`

---

## 3. Database

- PostgreSQL only â€” NEVER SQLite for any new work
- All PKs: `UUIDField(primary_key=True, default=uuid.uuid4, editable=False)`
- Every tenant-scoped model: `tenant_id = models.UUIDField(db_index=True)`
- Always index `tenant_id` and any frequently filtered field
- Migrations: small and incremental â€” no large data migrations without rollback plan

---

## 4. Model Categories

Every model in this project falls into one of three categories. Apply the correct
base class â€” do not mix them.

---

### 4a. Tenant-Scoped Data (`TenantScopedModel`)

Use for all business data that belongs to a workspace: invoices, documents, tasks,
any future feature models.

```python
class TenantScopedModel(models.Model):
    id         = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    tenant_id  = models.UUIDField(db_index=True)          # always indexed â€” drives RLS
    created_at = models.DateTimeField(auto_now_add=True)
    created_by = models.UUIDField(null=True, blank=True)   # acting user UUID
    updated_at = models.DateTimeField(auto_now=True)
    updated_by = models.UUIDField(null=True, blank=True)   # acting user UUID
    is_active  = models.BooleanField(default=True, db_index=True)
    deleted_at = models.DateTimeField(null=True, blank=True)
    deleted_by = models.UUIDField(null=True, blank=True)   # acting user UUID
    class Meta:
        abstract = True
```

> All actor fields (`created_by`, `updated_by`, `deleted_by`) are `UUIDField`:
> no FK constraint, no implicit index, no JOIN overhead, no circular dependency on `User`.
> The service layer always sets them from a validated `request.user.pk`.
> There is **no circular risk here** â€” a tenant admin or member always exists before
> any tenant-scoped record is created.
> Add `db_index` on an actor field only if a concrete query pattern warrants it.

Rules:

- `tenant_id` is always indexed (drives PostgreSQL RLS and query isolation)
- `is_active` is always indexed (all live queries filter on it)
- `created_by` / `updated_by` / `deleted_by` are **not** indexed by default
- NEVER raw SQL â€” always use the Django ORM
- Keep `models.py` thin â€” no business logic

---

### 4b. Non-Tenant Audited Data (`TimeStampedAuditModel`)

Use for system-level models that are not scoped to a tenant but still need a full
audit trail: `UserProfile`, `Tenant`, and future system-wide records.

```python
class TimeStampedAuditModel(models.Model):
    id         = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    created_at = models.DateTimeField(auto_now_add=True)
    created_by = models.UUIDField(null=True, blank=True)   # acting user UUID
    updated_at = models.DateTimeField(auto_now=True)
    updated_by = models.UUIDField(null=True, blank=True)   # acting user UUID
    is_active  = models.BooleanField(default=True, db_index=True)
    deleted_at = models.DateTimeField(null=True, blank=True)
    deleted_by = models.UUIDField(null=True, blank=True)   # acting user UUID
    class Meta:
        abstract = True
```

> Same hybrid-integrity approach as `TenantScopedModel` â€” all actor fields are
> `UUIDField`. No circular risk: for `UserProfile`, the `User` row is committed
> before the signal creates the profile, so `user.pk` is always a valid UUID when
> these records are written.

Rules: same as Â§4a except no `tenant_id`.

---

### 4c. Reference / Lookup Tables

Use for controlled-vocabulary tables that are never edited by end-users:
`Country`, `Language`, `Timezone`, `Currency` (see Â§5b).

```python
class models.Model:  # plain Django model â€” no base class
    # no soft-delete, no audit fields, no tenant_id
    # loaded once via load_reference_data management command
```

---

### 4d. `User` â€” The Sole Exception

`User` extends `AbstractUser` directly. It does **not** extend `TenantScopedModel`
or `TimeStampedAuditModel`.

- **No `created_by` / `updated_by` on `User`** â€” ever.
  - Self-registration: the user's own UUID doesn't exist yet when the row is inserted.
  - Superuser bootstrap: there is no prior actor.
  - These two cases cannot be made consistent. Leave `User` clean.
- `User` carries the `AbstractUser` `is_active` field (Django standard).
- Add `deleted_at` and `deleted_by` directly on `User` (soft-delete audit trail):
  `deleted_by` here means "the admin who deactivated this account" â€” that admin
  always exists before the deactivation write.
- **NEVER hard-delete a `User`** â€” set `is_active = False` only.

---

## 5. User Model

- ALWAYS subclass `AbstractUser` in `apps/users/`
- Set `USERNAME_FIELD = "email"` and `REQUIRED_FIELDS = []`
- Provide a custom `UserManager` with `create_user(email, password, ...)` and `create_superuser(email, password, ...)`
- Set `AUTH_USER_MODEL = "users.User"` in `config/settings/base.py` before the first migration
- After creating the User model for the first time, run:
  ```
  uv run python manage.py makemigrations
  uv run python manage.py migrate
  uv run python manage.py createsuperuser
  ```
- Login/logout always uses **email + password**, never username
- The `User` model itself stays minimal â€” all optional profile data lives in `UserProfile`
- **NEVER hard-delete a `User` record.** Set `is_active = False` instead.
  Hard deletion cascades silently and breaks foreign keys across the system.
- **`User` has NO `created_by` or `updated_by` fields â€” this is the only exception in the
  entire codebase.** Self-registration creates the user's UUID in the same transaction, so
  there is no prior actor to record. Use `TimeStampedAuditModel` for every other model.

---

## 5a. UserProfile Model

`UserProfile` is a separate model in `apps/users/` with a `OneToOneField` to `User`.
It holds all optional, editable, user-visible preferences. It is **never** part of
the registration form â€” it is created automatically after registration via a signal.

**NEVER hard-delete a `UserProfile` record.** Set `is_active = False` instead.

Fields:

```python
class UserProfile(TimeStampedAuditModel):
    user         = models.OneToOneField(settings.AUTH_USER_MODEL,
                       on_delete=models.CASCADE, related_name="profile")
    # Display
    display_name = models.CharField(max_length=100, blank=True, null=True)
                   # nullable; auto-populated from email on creation (see below)

    # Localisation â€” FK to ISO reference tables (see Â§5b)
    language     = models.ForeignKey(
                       "core.Language", null=True, blank=True,
                       on_delete=models.SET_NULL, related_name="+"
                   )
    timezone     = models.ForeignKey(
                       "core.Timezone", null=True, blank=True,
                       on_delete=models.SET_NULL, related_name="+"
                   )
    country      = models.ForeignKey(
                       "core.Country", null=True, blank=True,
                       on_delete=models.SET_NULL, related_name="+"
                   )
    # currency is NOT on UserProfile â€” it belongs on Tenant (billing/invoicing).
    # See AGENTS.md ADR 52.

    # UI preferences
    theme        = models.CharField(
                       max_length=20,
                       choices=[("corporate","Light"),("night","Dark"),("system","System")],
                       default="system"
                   )

    # Marketing
    marketing_emails = models.BooleanField(default=False)
                       # newsletters opt-in only â€” no product_updates field

    # Onboarding gate
    profile_completed_at = models.DateTimeField(null=True, blank=True)
                           # None until the user saves the profile form for the
                           # first time; drives the ProfileCompleteMiddleware gate

    # Workspace membership â€” one user, one tenant, forever
    tenant     = models.ForeignKey(
                     "tenants.Tenant", null=True, blank=True,
                     on_delete=models.SET_NULL, related_name="members"
                 )
                 # Null = not yet assigned (new user in onboarding).
                 # Set once during onboarding Step 2 (workspace creation) or when
                 # an owner invites the user.
                 # NEVER nulled out after assignment â€” it is the permanent audit
                 # record of which organisation the user belonged/belongs to.
    role       = models.CharField(
                     max_length=20,
                     choices=[("admin", "Admin"), ("member", "Member")],
                     default="member",
                     blank=True
                 )
                 # "admin"  â€” can manage members, billing, and tenant settings
                 # "member" â€” regular member; read access only
                 # Blank when tenant is null (pre-onboarding)
    tenant_joined_at  = models.DateTimeField(null=True, blank=True)
                        # Set when the user first joins or is invited to a tenant
    tenant_revoked_at = models.DateTimeField(null=True, blank=True)
                        # Set when an owner revokes access; cleared on re-engagement
                        # is_active (inherited) = False while revoked
```

**Auto-population on registration (signal):**

- `display_name`: take the string left of `@` in the email; if it contains `.`, take
  the string left of the first `.` (e.g. `peter.janssens@...` â†’ `peter`)
- `language` / `timezone` / `country`: attempt to detect from the browser's
  `Accept-Language` header and `Intl.DateTimeFormat().resolvedOptions().timeZone`
  (passed as a hidden field on the registration form)
- All detected values are suggestions â€” the user can edit them at any time in `/profile/`

**Profile form (`/profile/`):**

- Editable fields: `display_name`, `timezone`, `country`, `theme`, `marketing_emails`
- Language is switched via the **navbar language selector** (flag + 2-letter code dropdown),
  NOT via the profile form. The profile form does not contain a language field.
- Login required
- Does NOT include email or password (those are in a separate settings section)
- Theme preference in the profile form **also** updates `localStorage` key `theme`

**Navbar:** see Â§11 for the full navigation layout spec, including the authenticated
`display_name` dropdown, mobile bottom nav, and aria requirements.

---

## 5b. Reference Data â€” Countries, Languages, Timezones, Currencies

All ISO reference tables live in `apps/core/` and are loaded once via a management
command (`uv run python manage.py load_reference_data`). They are **not** editable
by end-users and have no soft-delete â€” they are controlled vocabulary.

### Country (`core.Country`)

```python
class Country(models.Model):
    code    = models.CharField(max_length=2, unique=True)    # ISO 3166-1 alpha-2 (e.g. "BE")
    code3   = models.CharField(max_length=3, unique=True)    # ISO 3166-1 alpha-3 (e.g. "BEL")
    name    = models.CharField(max_length=200)
    numeric = models.CharField(max_length=3, blank=True)     # ISO 3166-1 numeric

    # Auto-integer PK (Category C â€” no UUID, no soft-delete).
    # flag_emoji is NOT stored in the DB â€” compute it in templates via the
    # {{ country.code|flag_emoji }} filter defined in core/templatetags/tz_tags.py.

    class Meta:
        ordering = ["name"]
        verbose_name_plural = "countries"
```

### Language (`core.Language`)

```python
class Language(models.Model):
    code      = models.CharField(max_length=8, unique=True)  # BCP-47 / ISO 639-2/3 (e.g. "nld", "fra")
    name      = models.CharField(max_length=200)             # display name (from pycountry)
    countries = models.ManyToManyField("core.Country", blank=True, related_name="languages")
    # allows filtering: Language.objects.filter(countries__code="BE")

    # Auto-integer PK. There is NO name_en field.

    class Meta:
        ordering = ["name"]
```

### Timezone (`core.Timezone`)

```python
class Timezone(models.Model):
    name           = models.CharField(max_length=100, unique=True)  # IANA tz (e.g. "Europe/Brussels")
    label          = models.CharField(max_length=200)               # human label: "Europe/Brussels (UTC+01:00)"
    offset_seconds = models.IntegerField(default=0)                 # raw UTC offset for ordering/display
    countries      = models.ManyToManyField("core.Country", blank=True, related_name="timezones")
    # allows filtering: Timezone.objects.filter(countries__code="BE")

    # Auto-integer PK. There are NO offset_std / offset_dst fields â€” use offset_seconds.
    # In templates use {{ tz.label }}, not {{ tz.offset_label }} (that field does not exist).

    class Meta:
        ordering = ["offset_seconds", "name"]
```

### Currency (`core.Currency`)

```python
class Currency(models.Model):
    code      = models.CharField(max_length=3, unique=True)  # ISO 4217 alphabetic (e.g. "EUR")
    name      = models.CharField(max_length=200)
    numeric   = models.CharField(max_length=3, blank=True)   # ISO 4217 numeric
    countries = models.ManyToManyField("core.Country", blank=True, related_name="currencies")
    # allows filtering: Currency.objects.filter(countries__code="BE")

    # Auto-integer PK. There are NO symbol or decimals fields.

    class Meta:
        ordering = ["code"]
        verbose_name_plural = "currencies"
```

### Filtering patterns

```python
# Languages available for a country
Language.objects.filter(countries__code="BE")

# Timezones for a country
Timezone.objects.filter(countries__code="BE")

# Currencies for a country
Currency.objects.filter(countries__code="BE")
```

### Data source

Populate from `pycountry` (PyPI) in the `load_reference_data` management command:

- `uv add pycountry`
- Countries, languages, currencies: `pycountry.countries`, `pycountry.languages`, `pycountry.currencies`
- Timezones: `zoneinfo.available_timezones()` + `zoneinfo.ZoneInfo` for offset calculation
- Run the command once after initial migrations and in CI seed steps

---

## 5c. Tenant Model

`Tenant` lives in `apps/tenants/`. There is no `TenantMembership` model â€” membership
is recorded directly on `UserProfile` (see Â§5a).

```python
class Tenant(TimeStampedAuditModel):
    id           = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    organization = models.CharField(max_length=200)   # workspace / company name (required)
    # Tenant IS the root â€” it has no tenant_id on itself; use TimeStampedAuditModel not TenantScopedModel
    # No slug â€” UUID PK is the identifier; add slug only if tenant-scoped URLs are needed
```

**One user, one tenant â€” hard product constraint:**

- A `UserProfile.tenant` FK is set once (during onboarding or on invitation) and
  **never nulled out after assignment**.
- A user who needs to belong to a different organisation must register a new account
  with a different email address.
- Revocation (`is_active = False`) does not clear the `tenant` FK â€” the link is the
  permanent audit record of which organisation the account belonged to.

**Revocation lifecycle:**

| Action              | `is_active` | `tenant_revoked_at` | `deleted_by` | `tenant` FK     |
| ------------------- | ----------- | ------------------- | ------------ | --------------- |
| Active member       | `True`      | `None`              | `None`       | set             |
| Revoked             | `False`     | `now()`             | admin UUID   | set (unchanged) |
| Re-engaged          | `True`      | `None`              | `None`       | set (unchanged) |
| Anonymised (future) | `False`     | set                 | set          | set (unchanged) |

**Owner constraint:** The admin of a tenant cannot revoke themselves.
Enforced at the service layer â€” `services.revoke_member()` raises `ValueError` if
`admin_profile.pk == target_profile.pk`.

**Member management UI** lives at `/settings/members/` â€” `admin`-only (403 for members).
Queries: `UserProfile.objects.filter(tenant=request.user.profile.tenant)`.

---

## 6. Views & Business Logic

- CBVs (Class-Based Views) for non-trivial logic, FBVs (Function-Based Views) for simple endpoints
- Views must stay thin â€” delegate to `services.py` / `selectors.py`
- `services.py` â€” write/mutation logic
- `selectors.py` â€” read/query logic
- `tasks.py` â€” async/background work (Celery or Django-Q)

### Login UX

- **Login failure** (wrong credentials): stay on the login form and display an inline
  error message â€” do **NOT** redirect anywhere. The user must be able to try again immediately.
- **Login cancel** (user actively navigates away, clicks "Back", or hits a "Cancel" link
  on the login page): redirect to **homepage** (`/`).
- After successful login â†’ proceed to `?next` param (or `/dashboard/`).
- Unauthenticated access to protected pages â†’ redirect to **login page** (with `?next`).

### Registration Flow

- After successful registration â†’ skip email confirmation â†’ auto-create `UserProfile`
  via signal â†’ redirect to `/profile/complete/` with page title **"Complete your profile"**.

### Extended Onboarding Flow

New users pass through a two-step onboarding gate after registration:

```
Register â†’ Login â†’ Middleware Check â”€â”€â†’ /profile/complete/   (Step 1: profile incomplete)
                                    â”€â”€â†’ /onboarding/create-tenant/  (Step 2: no tenant)
                                    â”€â”€â†’ Destination            (fully set up)
```

**Step 1 â€” Profile Completion (`/profile/complete/`):**

- Collect: `display_name` (optional), `timezone` (optional), `country` (optional)
- No language field â€” language is changed via the navbar language selector
- Show a DaisyUI **steps** progress indicator: `Profile â†’ Workspace` (step 1 of 2)
- **"Do this later"** button: sets `request.session["skip_profile_gate"] = True`
  so the middleware does not redirect them again during this browser session,
  even if `profile_completed_at` is still `None`
- On form save: set `profile_completed_at = now()` â†’ redirect to Step 2
  (`/onboarding/create-tenant/`)

**Step 2 â€” Tenant Creation (`/onboarding/create-tenant/`):**

- User creates their first Workspace (Tenant): provide `organization` (workspace name)
- Show the same DaisyUI **steps** progress indicator: `Profile â†’ Workspace` (step 2 of 2)
- On save: create `Tenant`, set `profile.tenant = tenant`, `profile.role = "admin"`,
  `profile.tenant_joined_at = now()`, `profile.is_active = True` â†’ redirect to `/dashboard/`
- The creating user is the **admin** of the tenant and can invite/remove members

**Middleware (`ProfileCompleteMiddleware` in `apps/users/middleware.py`):**

Runs on every request **after** `AuthenticationMiddleware`. Only applies to
**authenticated** users. Decision logic:

1. If `profile_completed_at` is `None` AND `request.session.get("skip_profile_gate")` is not `True`:
   â†’ redirect to `/profile/complete/?next=<original_url>`
2. Else if `request.user.profile.tenant_id` is `None`:
   â†’ redirect to `/onboarding/create-tenant/?next=<original_url>`
3. Else if `request.user.profile.is_active` is `False`:
   â†’ redirect to `/account/revoked/` (inform the user their access has been revoked)
4. Else: proceed normally.

Exempt from the gate (never redirected, even when checks fail):

- `/profile/complete/`
- `/onboarding/create-tenant/`
- `/account/revoked/`
- `/logout/`
- `/health/`
- Any URL matching `settings.PROFILE_GATE_EXEMPT_URLS` (a list in `base.py`, default `[]`)

Public pages (unauthenticated access allowed) are unaffected.

### Tenant Member Management

- One user belongs to exactly one tenant â€” enforced at the service layer.
  A second workspace requires a new user account with a different email address.
- `role` values: `admin` and `member` only. No additional roles until a concrete
  permission need arises.
- `admin` capabilities: invite members by email, revoke access, re-engage revoked members,
  manage tenant billing and settings. An admin **cannot** revoke themselves.
- `member` capabilities: none â€” read access to tenant data only.
- Member management UI lives at `/settings/members/` â€” `admin`-only; non-admins get 403.
- **Invite:** admin enters an email â†’ look up or create `User` + `UserProfile` â†’
  set `profile.tenant`, `profile.role = "member"`, `profile.tenant_joined_at = now()`,
  `profile.is_active = True` â†’ send invitation email via `send_mail` (no Celery yet).
  Inviting an email whose profile already has `tenant_id` set (regardless of `is_active`)
  is a validation error â€” one user, one tenant, always.
- **Revoke:** set `profile.is_active = False`, `profile.tenant_revoked_at = now()`,
  `profile.deleted_by = request.user.pk`. The `tenant` FK is **never cleared**.
- **Re-engage:** set `profile.is_active = True`, `profile.tenant_revoked_at = None`,
  `profile.deleted_by = None`, `profile.deleted_at = None`.

---

## 7. App Structure (per app)

```
apps/<name>/
  models.py
  views.py
  urls.py
  services.py
  selectors.py
  tasks.py        # if async work needed
  admin.py
  apps.py
  migrations/
  tests/
    __init__.py
    test_models.py
    test_views.py
    test_services.py
```

---

## 8. Frontend â€” Tailwind + DaisyUI

- ALWAYS use **Tailwind CSS** + **DaisyUI** for all templates
- Default DaisyUI theme: **corporate** (light) / **night** (dark)
- Default mode: **follow system** (`prefers-color-scheme`)
- Theme preference stored in `localStorage` key `theme`
- Use DaisyUI **skeleton** component during form loads and theme switches to prevent layout shifts
- Use DaisyUI **hero** component for auth pages (split-screen on desktop: inspirational image left, form right)
- Auth forms: centered vertically + horizontally on desktop; `items-start` on mobile so keyboard doesn't overlap fields
- Mobile: **Full-Width Buttons**; use "Top-to-Fill" standard for form fields
- NEVER use a top-right hamburger menu on mobile â€” use **Bottom Navigation** or **Full-Screen Overlay** instead
- All buttons, inputs, cards, alerts: DaisyUI components first, custom CSS only if DaisyUI has no equivalent

### DaisyUI 5 â€” breaking changes (we are on DaisyUI 5)

- **Forms:** `form-control` class is **removed** in DaisyUI 5.
  Use the new `fieldset` + `label` component syntax for every form field:

  ```html
  <fieldset class="fieldset">
    <label class="label">â€¦</label>
    <input class="input w-full" â€¦ />
    <p class="label">â€¦</p>
    {# hint / error text #}
  </fieldset>
  ```

  `label` now goes inside `fieldset`. Do not use `form-control` â€” it no longer exists.
  See: https://daisyui.com/components/fieldset/

- **Bottom navigation:** `btm-nav` / `btm-nav-item` / `btm-nav-label` are **renamed** in DaisyUI 5:
  - `btm-nav` â†’ `dock`
  - `btm-nav-item` â†’ removed (direct children of `dock` are styled automatically)
  - `btm-nav-label` â†’ `dock-label`
    Do NOT use the old `btm-nav` class names in any new template code.

---

## 9. Anti-Flash Script (theme)

Place this script in `<head>` of `base.html` **before any CSS or `<body>` tags**.

**Three-state preference model:** `"corporate"` (light) | `"night"` (dark) | `"system"` (follow OS).

- `localStorage` key `theme` always stores the logical pref (may be `"system"`).
- For **authenticated users** the server injects their saved `UserProfile.theme` via
  `{{ current_theme }}` (from `config/context_processors.py`). This wins over any
  stale `localStorage` value so a fresh browser / incognito window gets the right
  theme on first paint.
- For **unauthenticated users** `localStorage` is the only source of truth.
- `"system"` resolves to the actual DaisyUI theme at runtime by reading
  `prefers-color-scheme` â€” never stored as a resolved value.

```html
<script>
  (function () {
    {% if user.is_authenticated %}
    var serverTheme = '{{ current_theme }}'; // "corporate" | "night" | "system"
    var pref = serverTheme || localStorage.getItem('theme') || 'system';
    {% else %}
    var pref = localStorage.getItem('theme') || 'system';
    {% endif %}
    var resolved = (pref === 'night') ? 'night'
                   : (pref === 'corporate') ? 'corporate'
                   : (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'night' : 'corporate');
    document.documentElement.setAttribute('data-theme', resolved);
    localStorage.setItem('theme', pref);
  })();
</script>
```

**Toggle cycle:** `corporate â†’ night â†’ system â†’ corporate â€¦`

A `POST /theme/set/` endpoint (`users:set_theme`) persists the preference to
`UserProfile.theme` for authenticated users. Unauthenticated users get a `200 ok`
but no DB write (localStorage-only).

**Important:** Never put `{# ... #}` Django template comments inside a `<script>` block.
Multi-line `{# #}` comments adjacent to or inside `<script>` tags render as literal
visible text in the browser. Use `//` JS comments inside scripts instead.

---

## 10. Templates & Context Processors

- Create a `context_processors.py` in `config/` (or a shared app) that injects into every template:
  - `SITE_NAME` (from settings)
  - `current_theme` (from request cookie or `localStorage` via initial render)
- Register it in `TEMPLATES â†’ OPTIONS â†’ context_processors` in `base.py`
- This ensures 404, 500, password-reset, and all error pages share the same look

---

## 11. Navigation Layout

### Desktop (â‰¥ lg breakpoint)

- **Top navbar** with:
  - Left: `H` (placeholder for logo) â†’ links to homepage
  - Centre: navigation links (currently: "Home" â†’ homepage)
  - Right: language selector â†’ light/dark/system toggle â†’ auth control
    - **Language selector:** flag emoji + 2-letter lowercase code (e.g. `ðŸ‡¬ðŸ‡§ en`,
      `ðŸ‡§ðŸ‡ª nl`, `ðŸ‡§ðŸ‡ª fr`); opens a DaisyUI dropdown with one `set_language` POST form
      per locale; the active language is shown **bold** in the dropdown.
      The navbar button shows the flag + code for the **current** active locale
      (driven by `{{ LANGUAGE_CODE }}` from `django.template.context_processors.i18n`).
    - **Not authenticated:** "Get started" button â†’ opens login page with link to register
    - **Authenticated:** show `display_name` (fall back to email local-part if null) as a
      DaisyUI **dropdown** button; menu items:
      - "Profile" â†’ `/profile/`
      - "Logout" â†’ `/logout/`
      - **Admin link is NOT in this dropdown** â€” it lives in the left sidebar only
- Use `<nav>` tag â€” never a generic `<div>` for navigation

### Left Sidebar (authenticated only)

- **`<body>` must be `h-screen flex flex-col overflow-hidden`** â€” never `min-h-screen`.
  This viewport-locks the entire layout so the sidebar stays visible regardless of
  main content length. Sidebar and main each scroll independently.
- Sidebar `<aside>`: `hidden md:flex flex-col` with fixed width and `border-r`
- Sidebar `<nav>`: `flex flex-col flex-1 gap-1 px-2 overflow-y-auto min-h-0`
- **Top of sidebar:** Dashboard link (and any future app-section links)
- **Settings link:** shown only when `{% if user.profile.role == "admin" and user.profile.tenant_id %}`;
  links to `{% url 'users:settings_users' %}` â€” the Settings gear icon for tenant admins
- **Bottom of sidebar (pinned):** "Django Admin" link â€” only when `{% if user.is_staff %}`;
  placed in a `<div class="mt-auto pt-2 border-t border-base-300">` after the nav links;
  labeled "Django Admin" (not "Admin") to distinguish from the product Settings link
- **Profile link is NOT in the sidebar** â€” it lives in the top-right `display_name`
  dropdown only. Do not add it to the sidebar.

### Mobile (< lg breakpoint)

- Bottom Navigation bar or Full-Screen Overlay
- Same options as desktop, mobile-friendly UX
- Authenticated user section in the overlay / bottom sheet:
  - Show `display_name` (or email local-part)
  - "Profile" and "Logout" as list items
  - Settings link (if `{% if user.profile.role == "admin" and user.profile.tenant_id %}`) as a list item
  - "Django Admin" link (if `{% if user.is_staff %}`) as a list item â€” labeled "Django Admin", not "Admin"
- Hamburger icon (if used): must have `aria-label="Toggle menu"`

### Django Admin

- `admin.site.site_url = "/dashboard/"` in `config/urls.py` â€” one-liner before `urlpatterns`.
  This makes the "View site" button in the Django admin header go to `/dashboard/`
  instead of `/`. No custom `AdminSite` subclass is needed.

---

## 12. I18N

- Supported locales: `en-us` (US English), `nl-be` (Belgian Dutch), `fr-be` (Belgian French)
- Use Django's `i18n` framework: `USE_I18N = True`, `LANGUAGE_CODE = "en-us"`
- `LANGUAGES = [("en", "English"), ("nl-be", "Nederlands"), ("fr-be", "FranÃ§ais")]` â€” use hyphenated codes
- Wrap all user-facing strings in `{% trans %}` / `_()` from the start
- **Language persistence:** Django 4+ uses a cookie (`LANGUAGE_COOKIE_NAME = "django_language"`)
  as the sole persistence mechanism â€” `LANGUAGE_SESSION_KEY` no longer exists.
  `LocaleMiddleware` reads this cookie on every request.
- **Language switching:** POST to Django's built-in `set_language` view at `/i18n/setlang/`
  (included via `path("i18n/", include("django.conf.urls.i18n"))`). The view sets the cookie
  and redirects back. Do NOT build a custom language-switch view.
- **`django.template.context_processors.i18n` is required** in `TEMPLATES â†’ OPTIONS â†’
context_processors`. Without it `{{ LANGUAGE_CODE }}` resolves to the static
  `settings.LANGUAGE_CODE` ("en") instead of the per-request active language.
- **Locale directory architecture:**
  - `locale/nl_BE/` â€” Belgian Dutch overrides (all project-specific translations)
  - `locale/fr_BE/` â€” Belgian French overrides (all project-specific translations)
  - `locale/nl/` â€” intentionally empty (header only); falls back to Django's built-in `nl` catalog
  - `locale/fr/` â€” intentionally empty (header only); falls back to Django's built-in `fr` catalog
  - Django resolves `nl-be` â†’ `nl_BE` â†’ walks `locale/nl_BE/` â†’ `locale/nl/` â†’ built-in `nl` automatically
- Generate `.po` / `.mo` files with:
  ```
  uv run python manage.py makemessages -l nl_BE
  uv run python manage.py makemessages -l fr_BE
  uv run python manage.py compilemessages
  ```
- **NEVER use `nl_BE`/`fr_BE` directory names in `LANGUAGES`** â€” use `nl-be`/`fr-be`; Django normalises the hyphenated codes internally
- **`LocaleMiddleware` placement:** must come between `SessionMiddleware` and `CommonMiddleware` in `MIDDLEWARE`
- `/i18n/set_language/` must be in `_ALWAYS_EXEMPT` in `ProfileCompleteMiddleware`

---

## 13. HTML Forms â€” General Rules

- Always use the correct HTML input `type`: `type="email"` for emails, `type="password"` for passwords, `type="tel"` for phone numbers, etc.
- Always label every input with `<label for="...">` or `aria-label`
- Use `autocomplete` attributes on all auth fields (`autocomplete="email"`, `autocomplete="current-password"`, etc.)

---

## 14. Accessibility

- Always use semantic HTML: `<nav>`, `<main>`, `<header>`, `<footer>`, `<section>`, `<article>`
- NEVER use a generic `<div>` where a semantic tag exists
- All interactive icons must have `aria-label`
- Hamburger/menu toggle: `aria-label="Toggle menu"`, `aria-expanded` state
- Colour contrast must meet WCAG AA minimum

### 14a. Form Validation & Errors

- A red border alone is **never** sufficient to communicate an error.
- Every input that fails validation **must** receive `aria-invalid="true"`.
- Every error message and hint text **must** be linked to its input via
  `aria-describedby="<error-id>"` â€” the element with that `id` must contain the
  human-readable error text.
- After a failed form submission the page **must not** simply reload silently.
  Move keyboard focus to either:
  - A **"Summary of Errors"** `<div role="alert">` at the top of the form listing
    all validation failures, **or**
  - The **first invalid input** directly.
- All DaisyUI form components: apply the `.input-error` / `.select-error` modifier
  class alongside `aria-invalid="true"` so the visual and assistive cues are in sync.

### 14b. Keyboard & Focus

- NEVER use `outline: none` without an equally visible custom focus indicator.
  DaisyUI provides default focus rings â€” keep them and ensure they are not obscured
  by sticky navbars or overlapping elements.
- Every page **must** have a **"Skip to Main Content"** link as the **first
  focusable element** in `<body>`. It must be visually hidden until focused:
  ```html
  <a
    href="#main-content"
    class="sr-only focus:not-sr-only focus:absolute focus:z-50
     focus:px-4 focus:py-2 focus:bg-base-100 focus:text-base-content"
  >
    Skip to main content
  </a>
  ```
  The target `<main id="main-content">` must exist on every page.
- **Focus trapping:** When a modal (`<dialog>`) or a full-screen mobile overlay is
  open, focus **must** be trapped inside it. Tabbing must not reach background content.
  Use a JS focus-trap utility (e.g. `focus-trap` npm package, or a small inline
  implementation). Release the trap when the element closes.
- **Logical tab order:** The DOM order must match the visual reading order
  (top â†’ bottom, left â†’ right). Never use `tabindex` values > 0 to reorder focus.
  Use `tabindex="0"` only to make non-interactive elements focusable when needed.

### 14c. Touch & Gestures (Mobile / Motor)

- **Minimum target size:** All interactive elements (buttons, links, inputs, toggles)
  must be at least **44 Ã— 44 px** (WCAG 2.5.5) â€” aim for 48 Ã— 48 px for primary actions.
  Apply `min-h-[44px] min-w-[44px]` (Tailwind) where DaisyUI defaults fall short.
- **No dragging-only actions:** Any feature that requires dragging (e.g. a Kanban board,
  a reorderable list, a range slider) **must** provide a button-based alternative
  (e.g. "Move up" / "Move down" arrow buttons, or a numeric input for a slider).
- **Orientation:** Content must work in both portrait and landscape orientations.
  Never lock orientation unless absolutely essential for the feature.

### 14d. Cognitive & Language

- Every page's `<html>` tag **must** carry a valid `lang` attribute matching the
  active Django locale (e.g. `<html lang="en">`, `<html lang="nl">`, `<html lang="fr">`).
  Set this dynamically via a template context variable, not hardcoded.
- **Consistent navigation:** The navbar, sidebar, and footer must appear in the
  same location and the same order across every page. Never reorder navigation items
  per page.
- **Autocomplete on personal data inputs:** Any field that collects information the
  browser can autofill **must** carry the correct `autocomplete` attribute:
  - `autocomplete="name"` / `autocomplete="given-name"`
  - `autocomplete="email"`
  - `autocomplete="current-password"` / `autocomplete="new-password"`
  - `autocomplete="tel"`
  - `autocomplete="country"`, `autocomplete="language"`, etc.
    This is required for WCAG 1.3.5 and helps users with cognitive disabilities.

---

## 15. Health Check

- Expose a `GET /health/` endpoint (FBV, no auth required)
- Returns `{"status": "ok", "db": "ok"}` â€” checks DB connectivity
- Lives in `apps/core/views.py` or a minimal `apps/health/` app

---

## 16. Security

- NEVER hardcode secrets â€” always `env("VAR_NAME")`
- NEVER commit `.env` â€” only `.env.example`
- prod.py must have: `SECURE_SSL_REDIRECT`, `SESSION_COOKIE_SECURE`, `CSRF_COOKIE_SECURE`, HSTS
- Validate and sanitise all user input
- CSRF protection on all state-changing endpoints

---

## 17. Multi-Tenancy

- Tenant isolation via `tenant_id` on every relevant model
- Never write cross-tenant queries unless explicitly instructed
- PostgreSQL Row-Level Security (RLS) is the long-term isolation goal

---

## 18. Date & Time â€” Store UTC, Display Local

- `USE_TZ = True` in `base.py` (already set by Django default) â€” NEVER disable
- All `DateTimeField` values are stored in UTC in the database
- All `DateTimeField` on models: never use `auto_now` / `auto_now_add` with naive datetimes
- Display layer: convert UTC â†’ user's local timezone using `UserProfile.timezone`
- Use `zoneinfo` (Python stdlib) for timezone conversion â€” `import zoneinfo`
- In templates: use a custom template filter or tag `{{ value|localtime:request.user.profile.timezone }}`
- Never display raw UTC to the end user (except in admin or debug views)
- Timezone selection in the profile form uses the IANA timezone database
  (e.g. `Europe/Brussels`, `America/New_York`) â€” use `zoneinfo.available_timezones()`

---

## 19. Background Tasks (Async)

- Use a task queue (Celery + Redis, or Django-Q) for any async work
- Required for: billing webhooks, long-running jobs, and eventually email sending
- Tasks live in `apps/<name>/tasks.py`
- NEVER block a web request with slow I/O
- **Phase 3 exception:** invitation emails use Django `send_mail` synchronously â€”
  Celery is deferred to Phase 6. Replace with a task once Celery is installed.

---

## 20. Code Quality

- After ANY new app, model, or file: `uv run ruff check --fix && uv run ruff format`
- Line length: 88 | Quote style: double | Import order: isort via ruff
- First-party modules: `config`, `apps`
- Every new feature MUST include tests under `apps/<name>/tests/`
- Run tests: `uv run python manage.py test`

### Django template formatting

- **NEVER let Prettier (or any HTML formatter) touch `templates/`.**
  Prettier collapses `{% %}` and `{# #}` tags onto the same line as surrounding
  HTML, which breaks Django's template parser with `TemplateSyntaxError`.
- Two safeguards are already in place and must be preserved:
  1. **`.prettierignore`** at the project root contains `templates/` â€” do not remove it.
  2. **`.vscode/settings.json`** has `"[html]": { "editor.formatOnSave": false }` â€” do not change it.
- If new template directories are added outside `templates/` (e.g. app-level
  `apps/<name>/templates/`), add them to `.prettierignore` as well.

---

## 21. Git

- Commit messages: imperative mood, concise subject + optional body
- Never commit: `.env`, `db.sqlite3`, `__pycache__`, `.DS_Store`, `staticfiles/`
- **After completing each phase** (all tasks done, tests passing, ruff clean):
  1. `git add -A`
  2. `git commit -m "feat: Phase N â€” <short summary>"`
  3. `git push`
- Do not wait to be asked â€” committing and pushing is part of finishing a phase

---

## 22. Working Style

- **Always propose before changing.** Before making any non-trivial edit (refactor,
  architecture change, file deletion, multi-file change), present a clear summary of
  _what_ will change and _why_, and wait for explicit approval. Trivial fixes
  (typos, lint errors, a single-line obvious correction) may be applied directly.
- **English only in all documentation and instructions.** All comments in code,
  all `.md` files, all docstrings, all commit messages, and all AI instruction files
  (`.clauderules`, `AGENTS.md`, `copilot-instructions.md`) must be written in English.
  The product UI is translated (see Â§12); the codebase itself is English-only.
