{% extends "users/settings_base.html" %}
{% load i18n %}

{% block tab_content %}

<div class="card bg-base-200 shadow-sm">
  <div class="card-body gap-4">

    <h2 class="card-title text-lg">{% trans "Invite a new member" %}</h2>

    <form method="post" action="{% url 'users:settings_users' %}" novalidate>
      {% csrf_token %}
      <input type="hidden" name="action" value="invite">
      <div class="flex gap-2 items-end flex-wrap">
        <fieldset class="flex-1 min-w-48">
          <label class="label" for="{{ invite_form.email.id_for_label }}">
            <span class="label-text">{{ invite_form.email.label }}</span>
          </label>
          <input
            type="email"
            name="{{ invite_form.email.html_name }}"
            id="{{ invite_form.email.id_for_label }}"
            class="input w-full text-base{% if invite_form.email.errors %} input-error{% endif %}"
            placeholder="{% trans 'colleague@example.com' %}"
            autocomplete="off"
            {% if invite_form.email.errors %}aria-invalid="true" aria-describedby="invite-email-error"{% endif %}
          >
          {% if invite_form.email.errors %}
          <span id="invite-email-error" class="text-error text-sm mt-1">
            {{ invite_form.email.errors|join:" " }}
          </span>
          {% endif %}
        </fieldset>
        <button type="submit" class="btn btn-primary min-h-[44px]">
          {% trans "Invite" %}
        </button>
      </div>
    </form>

  </div>
</div>

<div class="card bg-base-200 shadow-sm mt-4">
  <div class="card-body gap-0 p-0">

    <h2 class="text-lg font-semibold px-6 py-4">{% trans "Members" %}</h2>

    <div class="overflow-x-auto">
      <table class="table table-zebra w-full">
        <thead>
          <tr>
            <th>{% trans "Email" %}</th>
            <th>{% trans "Name" %}</th>
            <th>{% trans "Role" %}</th>
            <th>{% trans "Status" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for member in members %}
          <tr>
            <td>{{ member.user.email }}</td>
            <td>{{ member.display_name|default:"—" }}</td>

            {# Role column: clickable dropdown badge (admin can change roles) #}
            <td>
              {% if member.pk != admin_profile.pk %}
              <details class="dropdown">
                <summary class="badge cursor-pointer select-none gap-1
                  {% if member.role == 'admin' %}badge-primary{% else %}badge-ghost{% endif %}">
                  {% if member.role == "admin" %}{% trans "Admin" %}{% else %}{% trans "Member" %}{% endif %}
                  <svg xmlns="http://www.w3.org/2000/svg" class="size-3" viewBox="0 0 20 20"
                       fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd"
                          d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z"
                          clip-rule="evenodd"/>
                  </svg>
                </summary>
                <ul class="dropdown-content menu menu-sm bg-base-100 rounded-box shadow-lg z-10 w-40 p-1">
                  {% if member.role != "admin" %}
                  <li>
                    <form method="post" action="{% url 'users:settings_users' %}">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="set_role">
                      <input type="hidden" name="profile_id" value="{{ member.pk }}">
                      <input type="hidden" name="role" value="admin">
                      <button type="submit" class="w-full text-left">{% trans "Set as Admin" %}</button>
                    </form>
                  </li>
                  {% else %}
                  <li>
                    <form method="post" action="{% url 'users:settings_users' %}">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="set_role">
                      <input type="hidden" name="profile_id" value="{{ member.pk }}">
                      <input type="hidden" name="role" value="member">
                      <button type="submit" class="w-full text-left">{% trans "Set as Member" %}</button>
                    </form>
                  </li>
                  {% endif %}
                </ul>
              </details>
              {% else %}
              {# "You" row — cannot change own role #}
              <span class="badge {% if member.role == 'admin' %}badge-primary{% else %}badge-ghost{% endif %}">
                {% if member.role == "admin" %}{% trans "Admin" %}{% else %}{% trans "Member" %}{% endif %}
              </span>
              {% endif %}
            </td>

            {# Status column: toggle switch — submits confirm-gated form via JS #}
            <td>
              {% if member.pk != admin_profile.pk %}
              <form method="post" action="{% url 'users:settings_users' %}"
                    id="toggle-form-{{ member.pk }}">
                {% csrf_token %}
                <input type="hidden" name="action"
                       value="{% if member.is_active %}deactivate{% else %}reengage{% endif %}">
                <input type="hidden" name="profile_id" value="{{ member.pk }}">
                <input type="checkbox"
                       class="toggle toggle-success toggle-sm"
                       {% if member.is_active %}checked{% endif %}
                       aria-label="{% if member.is_active %}{% trans 'Deactivate' %}{% else %}{% trans 'Activate' %}{% endif %} {{ member.user.email }}"
                       onchange="confirmToggle(this, '{{ member.pk }}', '{{ member.user.email|escapejs }}', {{ member.is_active|lower }})">
              </form>
              {% else %}
              <span class="text-base-content/40 text-sm">{% trans "You" %}</span>
              {% endif %}
            </td>

          </tr>
          {% empty %}
          <tr>
            <td colspan="4" class="text-center text-base-content/60 py-6">
              {% trans "No members yet." %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function confirmToggle(checkbox, profileId, email, currentlyActive) {
  var msg = currentlyActive
    ? "{% trans 'Are you sure you want to deactivate this user?' %} (" + email + ")"
    : "{% trans 'Activate this user?' %} (" + email + ")";
  if (window.confirm(msg)) {
    document.getElementById("toggle-form-" + profileId).submit();
  } else {
    // Revert the checkbox to its previous state without submitting
    checkbox.checked = currentlyActive;
  }
}
</script>
{% endblock %}
