{% extends "users/settings_base.html" %}
{% load i18n %}

{% block tab_content %}

<div class="card bg-base-200 shadow-sm">
  <div class="card-body gap-4">

    <h2 class="card-title text-lg">{% trans "Invite a new member" %}</h2>

    <form method="post" action="{% url 'users:settings_users' %}" novalidate>
      {% csrf_token %}
      <input type="hidden" name="action" value="invite">
      <div class="flex gap-2 items-end flex-wrap">
        <fieldset class="flex-1 min-w-48">
          <label class="label" for="{{ invite_form.email.id_for_label }}">
            <span class="label-text">{{ invite_form.email.label }}</span>
          </label>
          <input
            type="email"
            name="{{ invite_form.email.html_name }}"
            id="{{ invite_form.email.id_for_label }}"
            class="input w-full text-base{% if invite_form.email.errors %} input-error{% endif %}"
            placeholder="{% trans 'colleague@example.com' %}"
            autocomplete="off"
            {% if invite_form.email.errors %}aria-invalid="true" aria-describedby="invite-email-error"{% endif %}
          >
          {% if invite_form.email.errors %}
          <span id="invite-email-error" class="text-error text-sm mt-1">
            {{ invite_form.email.errors|join:" " }}
          </span>
          {% endif %}
        </fieldset>
        <button type="submit" class="btn btn-primary min-h-[44px]">
          {% trans "Invite" %}
        </button>
      </div>
    </form>

  </div>
</div>

<div class="card bg-base-200 shadow-sm mt-4">
  <div class="card-body gap-0 p-0">

    <h2 class="text-lg font-semibold px-6 py-4">{% trans "Members" %}</h2>

    <div class="overflow-x-auto">
      <table class="table table-zebra w-full">
        <thead>
          <tr>
            <th>{% trans "Email" %}</th>
            <th>{% trans "Name" %}</th>
            <th class="w-20 text-center">{% trans "Admin" %}</th>
            <th class="w-20 text-center">{% trans "Active" %}</th>
          </tr>
        </thead>
        <tbody>
          {% for member in members %}
          <tr id="row-{{ member.pk }}">
            <td>{{ member.user.email }}</td>
            <td>
              <span class="inline-flex items-center gap-1.5">
                {{ member.display_name|default:"—" }}
                {% if member.pk == admin_profile.pk %}
                <span class="badge badge-sm border border-violet-400 text-violet-500 bg-transparent font-semibold tracking-wide">
                  {% trans "YOU" %}
                </span>
                {% endif %}
              </span>
            </td>

            {# Admin toggle — disabled on own row or when member is inactive #}
            <td class="text-center">
              {% if member.pk == admin_profile.pk %}
              <input type="checkbox"
                     class="toggle toggle-primary toggle-sm"
                     checked
                     disabled
                     aria-label="{% trans 'Admin' %} {{ member.user.email }}"
                     title="{% trans 'You' %}">
              {% else %}
              <form method="post" action="{% url 'users:settings_users' %}"
                    id="role-form-{{ member.pk }}" class="inline">
                {% csrf_token %}
                <input type="hidden" name="action" value="set_role">
                <input type="hidden" name="profile_id" value="{{ member.pk }}">
                <input type="hidden" name="role"
                       id="role-value-{{ member.pk }}"
                       value="{% if member.role == 'admin' %}member{% else %}admin{% endif %}">
                <input type="checkbox"
                       class="toggle toggle-primary toggle-sm"
                       id="admin-toggle-{{ member.pk }}"
                       {% if member.role == "admin" %}checked{% endif %}
                       {% if not member.is_active %}disabled{% endif %}
                       aria-label="{% trans 'Admin' %} {{ member.user.email }}"
                       onchange="submitRoleToggle('{{ member.pk }}', this.checked)">
              </form>
              {% endif %}
            </td>

            {# Active toggle — submits immediately, no confirmation #}
            <td class="text-center">
              {% if member.pk == admin_profile.pk %}
              <input type="checkbox"
                     class="toggle toggle-success toggle-sm"
                     checked
                     disabled
                     aria-label="{% trans 'Active' %} {{ member.user.email }}"
                     title="{% trans 'You' %}">
              {% else %}
              <form method="post" action="{% url 'users:settings_users' %}"
                    id="active-form-{{ member.pk }}" class="inline">
                {% csrf_token %}
                <input type="hidden" name="action"
                       id="active-action-{{ member.pk }}"
                       value="{% if member.is_active %}deactivate{% else %}reengage{% endif %}">
                <input type="hidden" name="profile_id" value="{{ member.pk }}">
                <input type="checkbox"
                       class="toggle toggle-success toggle-sm"
                       id="active-toggle-{{ member.pk }}"
                       {% if member.is_active %}checked{% endif %}
                       aria-label="{% trans 'Active' %} {{ member.user.email }}"
                       onchange="submitActiveToggle('{{ member.pk }}', this.checked)">
              </form>
              {% endif %}
            </td>

          </tr>
          {% empty %}
          <tr>
            <td colspan="4" class="text-center text-base-content/60 py-6">
              {% trans "No members yet." %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
function submitRoleToggle(profileId, isNowChecked) {
  // Update the hidden role value to match the new desired state
  document.getElementById("role-value-" + profileId).value = isNowChecked ? "admin" : "member";
  document.getElementById("role-form-" + profileId).submit();
}

function submitActiveToggle(profileId, isNowActive) {
  // Update action to match new state
  document.getElementById("active-action-" + profileId).value = isNowActive ? "reengage" : "deactivate";

  // If deactivating: also visually reset & disable the admin toggle immediately
  if (!isNowActive) {
    var adminToggle = document.getElementById("admin-toggle-" + profileId);
    if (adminToggle) {
      adminToggle.checked = false;
      adminToggle.disabled = true;
    }
  }

  document.getElementById("active-form-" + profileId).submit();
}
</script>
{% endblock %}
